{% extends "base.html" %}

{% block title %}Dashboard - –¢—Ä–µ–∫–µ—Ä –†–∞—Å—Ö–æ–¥–æ–≤{% endblock %}

{% block content %}
<h1 data-i18n="dashboard">–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>

<div class="stats-grid">
    <div class="stat-card income">
        <div class="stat-icon">üíµ</div>
        <div class="stat-value" id="income-value">...</div>
        <div class="stat-label" data-i18n="income_month">–î–æ—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü</div>
    </div>
    <div class="stat-card expense">
        <div class="stat-icon">üí≥</div>
        <div class="stat-value" id="expense-value">...</div>
        <div class="stat-label" data-i18n="expense_month">–†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü</div>
    </div>
    <div class="stat-card balance">
        <div class="stat-icon">üíé</div>
        <div class="stat-value" id="balance-value">...</div>
        <div class="stat-label" data-i18n="balance">–ë–∞–ª–∞–Ω—Å</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
    <div class="card">
        <h2 class="mb-4" data-i18n="expense_by_category">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
        <canvas id="expenseChart"></canvas>
    </div>
    <div class="card">
        <h2 class="mb-4" data-i18n="income_expense_trend">–¢—Ä–µ–Ω–¥ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h2>
        <canvas id="trendChart"></canvas>
    </div>
</div>

<div class="card">
    <h2 class="mb-4" data-i18n="recent_transactions">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h2>
    <table class="table">
        <thead>
            <tr>
                <th data-i18n="date">–î–∞—Ç–∞</th>
                <th data-i18n="description">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th data-i18n="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th data-i18n="amount">–°—É–º–º–∞</th>
            </tr>
        </thead>
        <tbody id="recent-transactions">
            <tr>
                <td colspan="4" style="text-align: center;" data-i18n="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
            </tr>
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
<script>
// Store chart instances globally to destroy them before recreating
let expenseChartInstance = null;
let trendChartInstance = null;

async function loadDashboard() {
    try {
        console.log('Loading dashboard...');
        const user = getUser();
        const currency = user?.currency || 'USD';

        // Initialize with 0 values in correct currency
        document.getElementById('income-value').textContent = formatCurrency(0, currency);
        document.getElementById('expense-value').textContent = formatCurrency(0, currency);
        document.getElementById('balance-value').textContent = formatCurrency(0, currency);

        // Load stats
        const stats = await API.getTransactionStats();
        console.log('Stats loaded:', stats);
        if (stats) {
            document.getElementById('income-value').textContent = formatCurrency(stats.current_month.income, currency);
            document.getElementById('expense-value').textContent = formatCurrency(stats.current_month.expense, currency);
            document.getElementById('balance-value').textContent = formatCurrency(stats.current_month.balance, currency);
        }

        // Load recent transactions
        const transactions = await API.getTransactions();
        console.log('Transactions loaded:', transactions);
        console.log('Transactions count:', transactions ? transactions.length : 0);

        if (!transactions || transactions.length === 0) {
            const tbody = document.getElementById('recent-transactions');
            tbody.innerHTML = `<tr><td colspan="4" style="text-align: center;" data-i18n="no_transactions">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td></tr>`;
        } else {
            const recentTransactions = transactions.slice(0, 5);
            const tbody = document.getElementById('recent-transactions');
            tbody.innerHTML = recentTransactions.map(t => `
                <tr>
                    <td>${formatDate(t.date)}</td>
                    <td>${t.description || '-'}</td>
                    <td>${t.category.icon} ${getCategoryName(t.category)}</td>
                    <td class="${t.type === 'income' ? 'text-success' : 'text-danger'}">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount, currency)}
                    </td>
                </tr>
            `).join('');
        }

    // Create expense chart
    const expenseCategories = {};
    const categoryColors = {};
    const expenseTransactions = transactions.filter(t => t.type === 'expense');

    expenseTransactions.forEach(t => {
        const catName = getCategoryName(t.category);
        expenseCategories[catName] = (expenseCategories[catName] || 0) + t.amount;
        // Store category color
        if (!categoryColors[catName] && t.category.color) {
            categoryColors[catName] = t.category.color;
        }
    });

    // Destroy old chart if it exists
    if (expenseChartInstance) {
        expenseChartInstance.destroy();
    }

    // Check if dark theme is active
    const isDarkTheme = document.body.classList.contains('dark-theme');
    const textColor = isDarkTheme ? '#e2e8f0' : '#1f2937';

    // Check if there's expense data
    const hasExpenseData = Object.keys(expenseCategories).length > 0;

    // Beautiful gradient color palette
    const defaultColors = [
        '#f97316',  // Orange - Food
        '#3b82f6',  // Blue - Transport
        '#8b5cf6',  // Purple - Housing
        '#10b981',  // Green - Health
        '#ec4899',  // Pink - Entertainment
        '#64748b',  // Slate - Other
        '#06b6d4',  // Cyan
        '#f59e0b',  // Amber
        '#6366f1',  // Indigo
        '#14b8a6'   // Teal
    ];

    // Map colors to categories, using category color if available
    const chartColors = Object.keys(expenseCategories).map((catName, index) => {
        return categoryColors[catName] || defaultColors[index % defaultColors.length];
    });

    // If no expense data, show placeholder
    const expenseChartData = hasExpenseData ? {
        labels: Object.keys(expenseCategories),
        datasets: [{
            data: Object.values(expenseCategories),
            backgroundColor: chartColors,
            borderWidth: 2,
            borderColor: isDarkTheme ? '#1e293b' : '#ffffff',
            hoverOffset: 8
        }]
    } : {
        labels: [t('no_data')],
        datasets: [{
            data: [1],
            backgroundColor: ['#e5e7eb'],
            borderWidth: 0
        }]
    };

    expenseChartInstance = new Chart(document.getElementById('expenseChart'), {
        type: 'doughnut',
        data: expenseChartData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: textColor,
                        font: {
                            size: 13,
                            weight: '500'
                        },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                datalabels: {
                    color: '#ffffff',
                    font: {
                        size: 14,
                        weight: 'bold'
                    },
                    formatter: function(value, context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return percentage > 5 ? percentage + '%' : ''; // Hide labels for slices < 5%
                    },
                    anchor: 'center',
                    align: 'center',
                    offset: 0
                },
                tooltip: {
                    backgroundColor: isDarkTheme ? '#1e293b' : '#ffffff',
                    titleColor: textColor,
                    bodyColor: textColor,
                    borderColor: isDarkTheme ? '#334155' : '#e2e8f0',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = formatCurrency(context.parsed, currency);
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Destroy old trend chart if it exists
    if (trendChartInstance) {
        trendChartInstance.destroy();
    }

    // Calculate real trend data from transactions
    const monthNames = {
        'ru': ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'],
        'en': ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        'lv': ['Jan', 'Feb', 'Mar', 'Apr', 'Mai', 'J≈´n', 'J≈´l', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec']
    };
    const currentLang = getCurrentLanguage();
    const now = new Date();
    const monthlyData = {};

    // Initialize last 6 months
    for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthlyData[monthKey] = { income: 0, expense: 0, label: monthNames[currentLang][date.getMonth()] };
    }

    // Aggregate transactions by month
    transactions.forEach(t => {
        const date = new Date(t.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (monthlyData[monthKey]) {
            if (t.type === 'income') {
                monthlyData[monthKey].income += t.amount;
            } else {
                monthlyData[monthKey].expense += t.amount;
            }
        }
    });

    const labels = Object.values(monthlyData).map(m => m.label);
    const incomeData = Object.values(monthlyData).map(m => m.income);
    const expenseData = Object.values(monthlyData).map(m => m.expense);

    // Create trend chart with real data
    const gridColor = isDarkTheme ? 'rgba(148, 163, 184, 0.2)' : 'rgba(0, 0, 0, 0.1)';
    const tickColor = isDarkTheme ? '#94a3b8' : '#6b7280';

    trendChartInstance = new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: t('income'),
                    data: incomeData,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: t('expense'),
                    data: expenseData,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: textColor,
                        font: {
                            size: 12
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: gridColor,
                        lineWidth: 1
                    },
                    ticks: {
                        color: tickColor,
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: gridColor,
                        lineWidth: 1
                    },
                    ticks: {
                        color: tickColor,
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    } catch (error) {
        console.error('Error loading dashboard:', error);
        alert(t('error_loading_data') + ': ' + error.message);
    }
}

// Make loadDashboard available globally for theme changes
window.reloadDashboard = loadDashboard;

// Initial load
loadDashboard();

// Reload dashboard when language changes
document.addEventListener('languageChanged', function() {
    console.log('Language changed, reloading dashboard');
    loadDashboard();
});
</script>
{% endblock %}
